<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Books - Shopping</title>

  <!-- Bootstrap 5.3 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

  <style>
    :root {
        --primary: #1e5fae;
        --track-bg: #e6e6e6;
        --thumb-size: 24px;
        --track-height: 6px;
    }


    body {
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      margin: 0;
    }

    .sidebar {
      background: #f7f7f7;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      height: fit-content;
    }

    .book-card {
        border: 1px solid #ddd;
        border-radius: 8px;
        transition: transform 0.2s, box-shadow 0.2s;
    }

    .book-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .footer {
      background-color: #333;
      color: white;
      padding: 16px 0;
      margin-top: auto;
    }

    .footer-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      max-width: 1200px;
      margin: auto;
      padding: 0 20px;
    }

    .footer-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .footer-logo {
      width: 36px;
      height: 36px;
    }

    .footer-right img {
      width: 28px;
      height: 28px;
      margin: 5px;
      cursor: pointer;
      transition: transform 0.2s;
    }

    .footer-right img:hover {
      transform: scale(1.1);
    }

    .price-filter {
        width: 100%;
        max-width: 300px;
        margin: 0 auto;
        font-family: Arial, sans-serif;
    }

    .price-filter .label {
        font-weight: 600;
        margin-bottom: 6px;
    }

        .range-row {
        display: flex;
        gap: 12px;
        align-items: center;
    }

    .slider {
        position: relative;
        flex: 1;
        height: 48px;
    }

    .slider .track {
        position: absolute;
        left: 0; right: 0;
        top: 50%;
        transform: translateY(-50%);
        height: var(--track-height);
        background: var(--track-bg);
        border-radius: 12px;
    }

    .slider .range {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        height: var(--track-height);
        background: var(--primary);
        border-radius: 12px;
        left: 0; width: 0;
    }

    /* Range inputs (invisible track, visible thumb) */
    .slider input[type="range"] {
        appearance: none;
        position: absolute;
        left: 0; right: 0;
        top: 0;
        width: 100%;
        height: 48px;
        background: transparent;
        pointer-events: none;
    }

    /* WebKit thumb (Chrome, Edge, Safari) */
    .slider input[type="range"]::-webkit-slider-thumb {
        -webkit-appearance: none;
        width: var(--thumb-size);
        height: var(--thumb-size);
        border-radius: 50%;
        background: var(--primary);
        border: 4px solid #fff;
        box-shadow: 0 0 0 4px var(--primary);
        cursor: pointer;
        pointer-events: auto;
    }

    /* Firefox thumb */
    .slider input[type="range"]::-moz-range-thumb {
        width: var(--thumb-size);
        height: var(--thumb-size);
        border-radius: 50%;
        background: var(--primary);
        border: 4px solid #fff;
        box-shadow: 0 0 0 4px var(--primary);
        cursor: pointer;
        pointer-events: auto;
    }

    .slider input[type="range"]::-webkit-slider-runnable-track,
    .slider input[type="range"]::-moz-range-track {
        background: transparent;
    }

    .slider input[type="range"].min { z-index: 5; }
    .slider input[type="range"].max { z-index: 6; }

    .go-btn {
        border: 1px solid #888;
        background: #fff;
        padding: 6px 14px;
        border-radius: 20px;
        cursor: pointer;
        min-width: 56px;
        transition: background 0.2s;
    }
    .go-btn:hover {
        background: #f2f2f2;
    }
  </style>
</head>

<body>

  <!-- ✅ Modern Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container">
      <a class="navbar-brand fw-bold" href="index.html">MyWebsite</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="index.html">Home</a></li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" data-bs-toggle="dropdown">Blogs</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#">AI</a></li>
              <li><a class="dropdown-item" href="#">Machine Learning</a></li>
              <li><a class="dropdown-item" href="#">Books</a></li>
            </ul>
          </li>
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle active" href="#" data-bs-toggle="dropdown">Shopping</a>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="product_book.html">Books</a></li>
              <li><a class="dropdown-item" href="#">Clothes</a></li>
            </ul>
          </li>
          <li class="nav-item"><a class="nav-link" href="about.html">About</a></li>
        </ul>
        <div class="d-flex">
          <a href="#register" class="btn btn-outline-light btn-sm me-2">Register</a>
          <a href="#login" class="btn btn-light btn-sm">Login</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Breadcrumb -->
  <div class="container mt-3">
    <nav aria-label="breadcrumb">
      <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="index.html">Home</a></li>
        <li class="breadcrumb-item">Shopping</li>
        <li class="breadcrumb-item active">Books</li>
      </ol>
    </nav>
  </div>

  <!-- Main Content -->
  <div class="container-fluid my-4">
    <div class="row">
      <!-- Sidebar -->
      <aside class="col-md-3 mb-4">
        <div class="price-filter">
            <div class="label">Price</div>
            <p><span id="minPrice"><b>₫0</b></span> – <span id="maxPrice"><b>₫500,000+</b></span></p>

            <div class="range-row">
                <div class="slider" id="slider">
                <div class="track"></div>
                <div class="range" id="activeRange"></div>
                <input class="min" id="min" type="range" min="0" max="500000" step="100" value="0">
                <input class="max" id="max" type="range" min="0" max="500000" step="100" value="500000">
                </div>
                <button class="go-btn" id="goBtn">Go</button>
            </div>
        </div>
      </aside>

      <!-- Books -->
      <section class="col-md-9">
        <div class="d-flex justify-content-end mb-3">
          <form class="d-flex" action="#" method="get">
            <input type="text" name="search" class="form-control me-2" placeholder="Search books...">
            <button type="submit" class="btn btn-primary">Search</button>
          </form>
        </div>

        <div class="d-flex justify-content-end align-items-center mb-3">
            <label for="sortSelect" class="me-2 fw-bold">Sort by:</label>
            <select id="sortSelect" class="form-select form-select-sm" style="width: 200px;">
                <option value="">Default</option>
                <option value="priceAsc">Price: Low → High</option>
                <option value="priceDesc">Price: High → Low</option>
                <option value="titleAsc">Title: A → Z</option>
                <option value="titleDesc">Title: Z → A</option>
            </select>
        </div>

        <div class="row g-3 book-list" id="bookList">
          <!-- JS will inject books here -->
        </div>

        <!-- Pagination controls -->
        <nav aria-label="Book pagination">
            <ul class="pagination justify-content-center mt-4" id="pagination"></ul>
        </nav>
      </section>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="footer-content">
      <div class="footer-left">
        <img src="images/logo.png" alt="Logo" class="footer-logo">
        <span class="fw-bold">MyWebsite</span>
      </div>
      <div class="footer-right">
        <img src="images/icons/fb_icon.png" alt="Facebook">
        <img src="images/icons/linkedin_icon.png" alt="LinkedIn">
        <img src="images/icons/ins_icon.png" alt="Instagram">
      </div>
    </div>
  </footer>

  <script>
    // === Elements ===
    const minInput = document.getElementById('min');
    const maxInput = document.getElementById('max');
    const activeRange = document.getElementById('activeRange');
    const minLabel = document.getElementById('minPrice');
    const maxLabel = document.getElementById('maxPrice');
    const goBtn = document.getElementById('goBtn');
    const bookList = document.querySelector('.book-list');
    const searchInput = document.querySelector('input[name="search"]');
    const searchForm = document.querySelector('form[action="#"]');
    const pagination = document.getElementById('pagination');
    const sortSelect = document.getElementById('sortSelect');
    const itemsPerPage = 6;
    let currentPage = 1;

    // === Data ===
    let books = [];
    function fetchBooks() {
        const min = Number(document.getElementById('min').value);
        const max = Number(document.getElementById('max').value);
        const keyword = document.querySelector('input[name="search"]').value.trim();

        fetch(`api/books.php?min=${min}&max=${max}&search=${encodeURIComponent(keyword)}`)
            .then(res => res.json())
            .then(data => {
            books = data;          // ← store global data
            renderBooks(1);        // ← now render using API data
            })
            .catch(err => console.error("Error fetching books:", err));
    }


    // === Helper ===
    function fmt(n) {
        return Number(n).toLocaleString('vi-VN');
    }

    // === Update slider UI ===
    function updateSliderUI() {
        const MIN = Number(minInput.min);
        const MAX = Number(maxInput.max);
        const STEP = Number(minInput.step);

        let minVal = Number(minInput.value);
        let maxVal = Number(maxInput.value);

        if (maxVal - minVal < STEP) {
            if (document.activeElement === minInput) minVal = maxVal - STEP;
            else maxVal = minVal + STEP;
        }

        const percentMin = ((minVal - MIN) / (MAX - MIN)) * 100;
        const percentMax = ((maxVal - MIN) / (MAX - MIN)) * 100;

        activeRange.style.left = percentMin + '%';
        activeRange.style.width = (percentMax - percentMin) + '%';

        minLabel.innerHTML = `<b>₫${fmt(minVal)}</b>`;
        maxLabel.innerHTML = `<b>₫${fmt(maxVal)}${maxVal >= MAX ? '+' : ''}</b>`;

        // Fix overlap issue
        minInput.style.zIndex = (minVal > maxVal - (MAX - MIN) * 0.05) ? 6 : 5;
        maxInput.style.zIndex = (minVal > maxVal - (MAX - MIN) * 0.05) ? 5 : 6;
    }

    /* Return array filtered by current price & search input */
    function getFilteredBooks() {
        const min = Number(minInput.value);
        const max = Number(maxInput.value);
        const keyword = (searchInput.value || '').trim().toLowerCase();

        // detect if max slider is at its end
        const isMaxAtEnd = max >= Number(maxInput.max);

        return books.filter(book => {
            const inPrice = book.price >= min && (isMaxAtEnd || book.price <= max);
            const matchesKeyword = keyword === '' || book.title.toLowerCase().includes(keyword);
            return inPrice && matchesKeyword;
        });
    }

    /* Render page of filtered books */
    function renderBooks(page = 1) {
        let filtered = getFilteredBooks();

        const sortValue = sortSelect.value;
        if (sortValue == 'priceAsc') {
            filtered.sort((a, b) => a.price - b.price);
        } else if (sortValue == 'priceDesc') {
            filtered.sort((a, b) => b.price - a.price);
        } else if (sortValue == 'titleAsc') {
            filtered.sort((a, b) => a.title.localeCompare(b.title, 'vi'));
        } else if (sortValue == 'titleDesc') {
            filtered.sort((a, b) => b.title.localeCompare(a.title, 'vi'));
        }
        const totalPages = Math.max(1, Math.ceil(filtered.length / itemsPerPage));

        // clamp page
        if (page < 1) page = 1;
        if (page > totalPages) page = totalPages;
        currentPage = page;

        const start = (page - 1) * itemsPerPage;
        const pageBooks = filtered.slice(start, start + itemsPerPage);

        // Clear and render
        bookList.innerHTML = '';
        if (pageBooks.length === 0) {
            bookList.innerHTML = `<div class="col-12 text-center text-muted py-4">Không có sách phù hợp.</div>`;
        } else {
            pageBooks.forEach(book => {
            bookList.innerHTML += `
                <div class="col-6 col-md-4 col-lg-3">
                <div class="card book-card h-100">
                    <img src="${book.image_url}" class="card-img-top" alt="${book.title}" style="height:180px;object-fit:contain;">
                    <div class="card-body text-center p-2">
                    <h6 class="card-title mb-1" style="font-size:14px;">${book.title}</h6>
                    <p class="text-muted mb-2" style="font-size:13px;">${fmt(book.price)} VND</p>
                    <a href="book_detail.html?title=${encodeURIComponent(book.title)}" class="btn btn-sm btn-primary">Chi tiết</a>
                    </div>
                </div>
                </div>`;
            });
        }

        renderPagination(filtered.length, totalPages);
    }

    /* Render pagination based on filteredTotal and totalPages */
    function renderPagination(filteredTotal, totalPages) {
        pagination.innerHTML = '';

        // Prev
        pagination.innerHTML += `
            <li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
            </li>`;

        // Show a compact range of page numbers (avoid rendering 50 links)
        const delta = 2; // pages to show around current
        const pages = [];
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - delta && i <= currentPage + delta)) {
            pages.push(i);
            } else if (pages[pages.length - 1] !== '...') {
            pages.push('...');
            }
        }

        pages.forEach(p => {
            if (p === '...') {
            pagination.innerHTML += `<li class="page-item disabled"><span class="page-link">…</span></li>`;
            } else {
            pagination.innerHTML += `
                <li class="page-item ${p === currentPage ? 'active' : ''}">
                <a class="page-link" href="#" data-page="${p}">${p}</a>
                </li>`;
            }
        });

        // Next
        pagination.innerHTML += `
            <li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
            </li>`;
    }

    /* Click handler for pagination */
    pagination.addEventListener('click', e => {
        const a = e.target.closest('a.page-link');
        if (!a) return;
        e.preventDefault();
        const page = Number(a.dataset.page);
        if (!isNaN(page)) renderBooks(page);
    });

    // === Event listeners ===
    minInput.addEventListener('input', updateSliderUI);
    maxInput.addEventListener('input', updateSliderUI);

    goBtn.addEventListener('click', e => {
        e.preventDefault();
        currentPage = 1;
        fetchBooks(1);
    });

    /* When user submits search form, reset to page 1 and render */
    if (searchForm) {
    searchForm.addEventListener('submit', e => {
        e.preventDefault();
        currentPage = 1;
        fetchBooks(1);
    });
    }

    // Optional: live search (real-time typing)
    searchInput.addEventListener('input', () => {
    renderBooks();
    });

    /* === Event listener for sort select === */
    sortSelect.addEventListener('change', () => {
        currentPage = 1;
        renderBooks(1);
    });

    // === Initial setup ===
    updateSliderUI();
    fetchBooks(); // ← get from API, not from hardcoded array

  </script>
</body>
</html>
